<!DOCTYPE html>

<!--
    Copyright Â© 2020, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.
    SPDX-License-Identifier: Apache-2.0
-->

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type" />

<title>ESP Log Viewer</title>

<script>
var _esp = null;
</script>

<!-- Run from an esp-connect install -->
<link rel="stylesheet" href="../esp-connect/style/connect.css" />
<script type="module">
import {esp} from "../esp-connect/js/ui/api.js"
_esp = esp;
</script>

<script>

var _connection = null;
var _maxentries = 100;
var _visuals = null;
var	_storage = null;
var _viewer = null;
var _parms = null;
var _k8s = null;

var _k8surl = "k8s-proxy://localhost:8001";

function
init()
{
    var tmp = new URL(".",document.URL);

    var proxy = "";
    proxy = "http://";
    proxy += tmp.hostname;
    proxy += ":";
    proxy += tmp.port;
    _esp.setHttpProxy(proxy);

    proxy = "ws://";
    proxy += tmp.hostname;
    proxy += ":";
    proxy += tmp.port;
    _esp.setWsProxy(proxy);

    _storage = _esp.getStorage("logviewer");

    _parms = _esp.getParms();
    _visuals = _esp.createVisuals(_esp.getParms());

    if (_parms.hasOwnProperty("filter") == false)
    {
        _parms["filter"] = "";
    }

    _parms["header"] = "ESP Server Log";

    _esp.handleLayout();

    loadNamespaces();
}

function
loadNamespaces()
{
    var k8s = _esp.createK8S(_k8surl);
    var namespaces = document.getElementById("namespaces");
    var projects = document.getElementById("projects");
    var current = _storage.getOpt("namespace");
    var option;
    var name;

    while (namespaces.length > 0)
    {
        namespaces.remove(0);
    }

    while (projects.length > 0)
    {
        projects.remove(0);
    }

    k8s.getNamespaces().then(
        function(result) {
            result.forEach((item) => {
                name = item.metadata.name;
                option = document.createElement("option");
                option.value = name;
                option.appendChild(document.createTextNode(name));
                option.selected = (name == current);
                namespaces.add(option);
            });

            if (current != null)
            {
                setNamespace(current);
            }
        }
    );
}

function
setNamespace(value)
{
    _storage.setOpt("namespace",value);

    var k8s = _esp.createK8S(_k8surl + "/" + value);
    var namespaces = document.getElementById("namespaces");
    var projects = document.getElementById("projects");
    var option;
    var name;

    while (projects.length > 0)
    {
        projects.remove(0);
    }

    var current = _storage.getOpt("project");

    k8s.getMyProjects().then(
        function(result) {
            result.forEach((item) => {
                name = item.metadata.name;
                option = document.createElement("option");
                option.value = name;
                option.appendChild(document.createTextNode(name));
                option.selected = (name == current);
                projects.add(option);
            });

            if (current != null)
            {
                setProject(current);
            }
        }
    );
}

function
setProject(value)
{
    _storage.setOpt("project",value);

    var namespaces = document.getElementById("namespaces");
    var url = _k8surl + "/" + namespaces.value + "/" + value;
    connect(url);
}



function
connect(server)
{
    if (_maxentries == 0 || isNaN(_maxentries))
    {
        _maxentries = 100;
    }

    if (_viewer != null)
    {
        if (_viewer.connection != null)
        {
            _viewer.connection.stop();
        }

        _viewer.setOpt("max",_maxentries);
    }

    _esp.connect(server,{ready:ready,closed:closed});

    _esp.getDialogs().clearModals();

    document.getElementById("bannerTitle").innerHTML = "ESP Log Viewer";

    _esp.size();

    _storage.setOpt("maxentries",_maxentries);
}

function
ready(connection)
{
    _connection = connection;

    if (_viewer == null)
    {
        _parms.enable_controls = true;
        //_parms.show_header = false;
        _parms.max = _maxentries;
        _viewer = _visuals.createLogViewer("viewer",null,_parms);
        _esp.size();
    }

    _viewer.connection = _connection;
}

function
closed(connection)
{
    _connection = null;
    _viewer = null;
}

</script>

</head>

<body onload="init()">

    <div id="banner">
        <table style="width:100%">
            <tr>
                <td id="bannerTitle">ESP Log Viewer</td>
                <td class="bannerControls">
                    <table class="bannerControls">
                        <tr>
                            <td class="namespace">
                                <span>Namespace:</span>
                                <select id="namespaces" onchange="setNamespace(this.value)"></select>
                            </td>
                            <td class="project">
                                <span>Project:</span>
                                <select id="projects" onchange="setProject(this.value)"></select>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>

    <div id="content" class="container" style="margin:auto">
        <div id="viewer" class="component" style="width:95%;height:95%"></div>
    </div>

    <div id="footer">&nbsp;</div>

    <!--
    <div id="connect" class="dialog" style="width:50%">

        <table class="dialogClose" style="width:100%">
            <tr><td class="icon"><a class="icon dialogTitle" href="javascript:_esp.getDialogs().popModal('connect')">&#xf10c;</a></td></tr>
        </table>

        <div class="dialogTop">

            <div  class="dialogHeader">
                <div class="dialogTitle">
                    <table style="width:100%;border:0">
                        <tr>
                            <td><div class="dialogTitle">Connect to ESP Server</div></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="dialogContent">
                <table border="0" style="width:100%;height:100%">
                    <tr><td class="dialogLabel">ESP Server:</td></tr>
                    <tr><td class="dialogValue"><input id="server" type="text"></input></td></tr>
                    <tr><td class="dialogLabel">Max Log Entries:</td></tr>
                    <tr><td class="dialogValue"><input id="maxentries" type="text"></input></td></tr>
                </table>
            </div>
        </div>
        <div class="dialogButtons">
            <table style="width:100%">
                <tr>
                    <td class="dialogButton">
                        <span><button class="close" onclick="javascript:connect()">Connect</button></span>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    -->

</body>

</html>
