<!DOCTYPE html>
<html>
<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<title>ESP Loose Ballast Demo</title>

<link rel="stylesheet" href="../../style/connect.css" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

<script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../js/ui/main"></script>

<script type="text/javascript">

var _api = null;
var _visuals = null;
var _visual = null;
var _conn = null;

function
esp(api)
{
    _api = api;

    var parms = api.getParms();

    if (parms.hasOwnProperty("server") == false)
    {
        alert("you must specify ESP server URL");
        return;
    }

    var server = parms["server"];
    delete parms["server"];

    document.getElementById("bannerTitle").innerHTML = document.title + " (" + server + ")";

    _api.connect(server,{ready:ready,closed:closed});
    _visuals = api.createVisuals(parms);
    _visuals.dateformat = {dateStyle:"short",timeStyle:"long",timeZone:"UTC"};

    _visuals.createWrapper("video",{style:{width:"40%",height:"400px"},header:"This is the actual video of the train rolling down the tracks",class:"component"});
    _visuals.addDelegate({selectionChanged:select});
   
    _api.handleLayout();
}

function
ready(connection)
{
    _conn = connection;

    if (_api.getParm("load",true))
    {
        _api.showStatus("Loading project...");
        _conn.loadProjectFrom("p","model.xml",{loaded:loaded,error:error},{overwrite:true});
    }
    else
    {
        loaded();
    }
}

var _publisher = null;
var _traindata = null;

function
loaded()
{
    _conn.getProjectXml("p",{response:function(c,data){document.getElementById("espModelXml").innerText = data;}});

    _api.clearStatus();
    //_publisher = _conn.getPublisher({window:"p/cq/image",dateformat:"%m/%d/%Y %H:%M",binary:true});
    _publisher = _conn.getPublisher({window:"p/cq/image",binary:true});
    _publisher.schema.addDelegate({schemaLoaded:loadData});

    if (_api.getParm("load",true))
    {
        _conn.publishUrl("p/cq/scoreRequest",new URL("astore_model.csv",document.URL).toString(),{publishComplete:createVisuals});
    }
    else
    {
        createVisuals();
    }
}

function
loadData()
{
    _conn.loadUrl("train","train_data.csv",{loaded:function(name,text){_traindata = _publisher.schema.createDataFromCsv(text,true);}});
}

function
createVisuals()
{
    var status = _conn.getEventCollection({window:"p/cq/engineStatus",exclude:["image_track_cropped"]});
    var alerts = _conn.getEventCollection({window:"p/cq/anomaliesDetected",name:"alerts"});
    var image = _conn.getEventStream({window:"p/cq/displayResizeImage",include:["_image_"],maxevents:1});

    status.addDelegate({dataChanged:speed});

    _visuals.createMap("tracker",status,{lat:"gps_latitude",lon:"gps_longitude",center:[-20.0490195,148.1542083],
                        size:15,color:"#3b99fc",zoom:10,tracking:true,popup:["LOCO_ID","DateTime","speed"],header:"This is the train's path"});

    _visuals.createImageViewer("image",image,{image:"_image_",header:"These are images returned from ESP after processing",scale:1});

    var colors = ["#e03531","#ff684c","#f0bd27","#51b364","#8ace7e"]

    _visuals.createGauge("trackHealth",status,{value:"TrackHealthPercent",range:[0,100],show_title:false,shape:"bullet",
                                segments:5,width:400,height:80,border:0,colors:colors,header:"Current track health"});

    _visuals.createGauge("engineSpeed",status,{value:"speed",range:[0,100],show_title:false,shape:"bullet",
                                segments:5,width:400,height:80,border:0,colors:colors,header:"Current engine speed"});

    _visuals.createMap("alerts",alerts,{lat:"latitude",lon:"longitude",center:[-20.0490195,148.1542083],zoom:13,size:10,
                        track_selected:true,tracking:true,color:"red",popup:["alertID","startTime","endTime"],
                        html:getAlertMarker,header:"This map shows the location of track health alerts"});

    _visuals.createTable("alertsTable",alerts,{values:["TrackHealthPercent","startTime","endTime"],header:"Track Health Alerts",tail:true});

    _api.size(1000);
}

function
speed(ds,data,clear)
{
    if (data != null && data.length > 0)
    {
        var o = data[data.length - 1];
        if (o.hasOwnProperty("speed"))
        {
            var video = document.getElementById("video");
            var ratio = parseFloat(o["speed"]) / 80;
            video.playbackRate = ratio;
        }
    }
}

function
getLocoMarker(map,data,color)
{
    var style = "font-size:12pt";
    return("<div class='mapicon' style='" + style + "'>&#xf0eb;</div>");
}

function
getAlertMarker(map,data,color,size,selected)
{
    var color = selected ? "red" : "black";
    var style = "width:10px;height:10px;background:" + color;
    return("<div class='mapicon' style='" + style + "'></div>");
}

function
sizeCanvas()
{
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    var width = video.videoWidth;
    var height = video.videoHeight;
    var size = 2000;

    if (width >= height)
    {
        var ratio = height / width;
        canvas.width = size;
        canvas.height = parseInt(size * ratio);
    }

    if (_api != null)
    {
        _api.size();
    }
}

function
error()
{
    alert("failed to load project");
}

function
started()
{
}

function
stopped()
{
}

function
publish()
{
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    context.drawImage(video,0,0,canvas.width,canvas.height);

    var data = canvas.toDataURL("image/jpeg",.3);
    var i = data.indexOf(",");
    data = data.substr(i + 1);

    var ratio = video.currentTime / video.duration;
    var index = parseInt(_traindata.length * ratio);

    if (index >= _traindata.length)
    {
        index = 0;
        index = _traindata.length;
    }

    var traindata = _traindata[index];

    var o = {};
    o["id"] = 1;

    for (var x in traindata)
    {
        o[x] = traindata[x];
    }

    o["position"] = video.currentTime;

    var date = new Date();

    o["DateTime"] = (date.getTime() * 1000);

    if (_publisher.isBinary())
    {
        var imagedata = atob(data);
        o["_image_"] = _api.createBuffer(imagedata);
    }
    else
    {
        o["image"] = data;
    }

    _publisher.add(o);
    _publisher.publish();
}

function
select(ds)
{
    if (ds.name == "alerts")
    {
        var selected = ds.getSelectedItems();

        if (selected.length == 1)
        {
            var video = document.getElementById("video");

            if (video.paused)
            {
                var data = selected[0];
                var position = data["position"];
                video.currentTime = position;
            }
        }
    }
}

function
init()
{
    var video = document.getElementById("video");
    video.addEventListener("play",started);
    video.addEventListener("pause",stopped);
    video.addEventListener("ended",stopped);
    video.addEventListener("timeupdate",publish);

    video.playbackRate = .5;
}

</script>

<style type="text/css">

</style>

</head>

<body onload="init()">

    <div id="banner">
        <table style="width:100%" cellspacing="0" cellpadding="0">
            <tr>
                <td id="bannerTitle"></td>
                <td class="icon">
                    <a class="icon" href="javascript:_api.getDialogs().pushModal('espModel')">&#xf426;</a>
                    <a class="icon" href="javascript:_api.getDialogs().pushModal('help')">&#xf30b;</a></td>
                </td>
            </tr>
        </table>
    </div>

    <div id="content">
        <div class="layout">
            <video id="video" style="width:90%;height:350px;outline:none" src="../data/ballast.mp4" controls="controls" onloadedmetadata="sizeCanvas()"></video>
            <div id="image" style="width:55%;height:400px"></div>
            <div class="container" style="width:30%;height:350px">
                <div id="engineSpeed" style="width:100%;height:50%;overflow:hidden"></div>
                <div id="trackHealth" style="width:100%;height:50%;overflow:hidden"></div>
            </div>
            <div id="tracker" style="width:30%;height:350px"></div>
            <div id="alerts" style="width:30%;height:350px"></div>
            <div id="alertsTable" style="width:35%;height:250px"></div>
        </div>
    </div>

    <canvas id="canvas" style="display:none"></canvas>

    <div id="footer">&nbsp;</div>

    <div id="help" class="dialog">
        <table class="dialogClose" style="width:100%" cellspacing="0" cellpadding="0">
            <tr><td class="icon"><a class="icon dialogTitle" href="javascript:_api.getDialogs().popModal('help')">&#xf10c;</a></td></tr>
        </table>

        <div class="dialogTop">

            <div  class="dialogHeader">
                <div class="dialogTitle">
                    <table style="width:100%;border:0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td><div class="dialogTitle">ESP Loose Ballast Demo</div></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="dialogContent">
            This example contains a video taken from the front of a train traveling through Australia. Each frame of the video is grabbed and sent to an ESP
            model with image object detection to look for track anomalies. In a second panel you will see the image that is sent back from the ESP model.
            <br/><br/>
            In order to run the model, you must copy the <a href="../data/loose_ballast.astore">loose ballast astore file</a>
            into the directory in which you are running your ESP server.
            <br/><br/>
            After you have done this, you can hit the play icon and start the video. As the video starts, each frame is grabbed and copied into an offscreen HTML
            canvas element. Then, the image data is taken out of the canvas and sent into the ESP image processing object detection
            model. The image is processed and sent back to the web page where it is displayed in the image viewer.
            <br/><br/>
            The page also has gauges to display the current speed of the engine as well as the current track health. If the track health falls below 75% you will see
            alerts pop up both in the geographic map and the alerts table. The course of the train is also depicted in a geographic map.
        </div>

        <div class="dialogButtons">
            <table style="width:100%">
                <tr>
                    <td class="dialogButton">
                        <span><button class="close" onclick="javascript:_api.getDialogs().popModal('help')">Done</button></span>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div id="espModel" class="dialog" style="width:90%;height:90%">

        <table class="dialogClose" style="width:100%" cellspacing="0" cellpadding="0">
            <tr><td class="icon"><a class="icon dialogTitle" href="javascript:_api.getDialogs().popModal('espModel')">&#xf10c;</a></td></tr>
        </table>

        <div class="dialogTop">

            <div  class="dialogHeader">
                <div class="dialogTitle">
                    <table style="width:100%;border:0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td><div class="dialogTitle">ESP Model</div></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="dialogContent" style="width:95%;height:70%;margin:auto">
            <pre id="espModelXml" class="model"></pre>
        </div>
    </div>



</body>

</html>
