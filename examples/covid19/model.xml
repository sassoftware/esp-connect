<project name="p" threads="4" pubsub="auto">
	<contqueries>
		<contquery name="cq" include-singletons="true">
			<windows>
				<window-source name="county">
					<schema>
						<fields>
							<field name="fips" type="string" key="true" />
							<field name="state" type="string" />
							<field name="county" type="string" />
							<field name="updated" type="stamp" />
							<field name="confirmed" type="int32" />
							<field name="active" type="int32" />
							<field name="deaths" type="int32" />
							<field name="tested" type="int32" />
							<field name="hospitalized" type="int32" />
							<field name="lat" type="double" />
							<field name="lon" type="double" />
						</fields>
					</schema>
				</window-source>
				<window-source name="centers">
					<schema>
						<fields>
							<field name="state" type="string" key="true" />
							<field name="center_lat" type="double" />
							<field name="center_lon" type="double" />
						</fields>
					</schema>
				</window-source>
				<window-source name="history" index="pi_HASH">
					<schema>
						<fields>
							<field name="state" type="string" key="true" />
							<field name="date" type="date" key="true" />
							<field name="totalTestResults" type="int32" />
							<field name="hospitalizedCurrently" type="int32" />
							<field name="hospitalizedCumulative" type="int32" />
							<field name="hospitalizedIncrease" type="int32" />
							<field name="onVentilatorCurrently" type="int32" />
							<field name="onVentilatorCumulative" type="int32" />
							<field name="inIcuCurrently" type="int32" />
							<field name="inIcuCumulative" type="int32" />
							<field name="totalTestResultsIncrease" type="int32" />
							<field name="positiveIncrease" type="int32" />
							<field name="negativeIncrease" type="int32" />
							<field name="negative" type="int32" />
							<field name="positive" type="int32" />
							<field name="pending" type="int32" />
							<field name="recovered" type="int32" />
							<field name="total" type="int32" />
							<field name="death" type="int32" />
							<field name="deathIncrease" type="int32" />
						</fields>
					</schema>
				</window-source>
                <window-join name="addCenter">
                    <join type="leftouter" no-regenerates="true">
                        <conditions>
                            <fields left="state" right="state"/>
                        </conditions>
                    </join>
                    <output>
                        <left-select>state,county,updated,confirmed,active,deaths,tested,hospitalized,lat,lon</left-select>
                        <right-select>center_lat,center_lon</right-select>
                    </output>
                </window-join>
				<window-aggregate name="state">
					<schema>
						<fields>
							<field name="state" type="string" key="true" />
							<field name="updated" type="stamp" />
							<field name="confirmed" type="int32" />
							<field name="active" type="int32" />
							<field name="deaths" type="int32" />
							<field name="tested" type="int32" />
							<field name="hospitalized" type="int32" />
							<field name="center_lat" type="double" />
							<field name="center_lon" type="double" />
							<field name="lat" type="double" />
							<field name="lon" type="double" />
						</fields>
					</schema>
					<output>
						<field-expr>ESP_aLast(updated)</field-expr>
						<field-expr>ESP_aSum(confirmed)</field-expr>
						<field-expr>ESP_aSum(active)</field-expr>
						<field-expr>ESP_aSum(deaths)</field-expr>
						<field-expr>ESP_aSum(tested)</field-expr>
						<field-expr>ESP_aSum(hospitalized)</field-expr>
						<field-expr>ESP_aFirst(center_lat)</field-expr>
						<field-expr>ESP_aFirst(center_lon)</field-expr>
						<field-expr>ESP_aFirst(lat)</field-expr>
						<field-expr>ESP_aFirst(lon)</field-expr>
					</output>
				</window-aggregate>
			</windows>
            <edges>
                <edge source="county centers" target="addCenter" />
                <edge source="addCenter" target="state" />
            </edges>
		</contquery>
	</contqueries>
</project>
