<!DOCTYPE html>

<html>

<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<title>ESP Image Object Detection</title>

<link rel="stylesheet" href="../../style/connect.css" />

<script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>
<script src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../js/ui/main"></script>

<script type="text/javascript">

var _esp = null;
var _conn = null;
var _visuals = null;
var _viewer = null;

function
esp(api)
{
    _esp = api;

    var parms = _esp.getParms();

    if (parms.hasOwnProperty("server") == false)
    {
        alert("you must specify ESP server URL");
        return;
    }

    var server = parms["server"];
    delete parms["server"];

    document.getElementById("bannerTitle").innerHTML = document.title + " (" + server + ")";

    _visuals = _esp.createVisuals(parms);

    _visuals.createWrapper("video",{header:"<br/>The video plays here",style:{width:"45%",height:"40%"}});
    _visuals.createWrapper("canvas",{header:"This image displays the current frame of the video. The bits are taken from the image and sent into the ESP object detection model.",style:{width:"45%",height:"40%"}});

    document.getElementById("video").style.display = "inline";

    _visuals.addDelegate({selectionChanged:select});

    _esp.handleLayout({layout:layout});

    _esp.connect(server,{ready:ready,closed:closed});
}

function
ready(connection)
{
    _conn = connection;

    if (_esp.getParm("load",true))
    {
        _conn.loadProjectFrom("p","model.xml",{loaded:loaded,error:error},{overwrite:true});
    }
    else
    {
        loaded();
    }
}

function
closed()
{
    _imagePublisher = null;
}

function
select(ds)
{
    if (ds.name == "objects")
    {
        var selected = ds.getSelectedItems();

        if (selected.length == 1)
        {
            var video = document.getElementById("video");

            if (video.paused)
            {
                var data = selected[0];
                var position = data["position"];
                video.currentTime = position;
            }
        }
    }
}

function
layout()
{
    /*
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    canvas.width = video.offsetWidth;
    canvas.height = video.offsetHeight;

    if (_viewer != null)
    {
        _viewer.setOpt("image_width",video.offsetWidth);
        _viewer.setOpt("image_height",video.offsetHeight);
        _viewer.drawImage();
    }
    */
}

var _imagePublisher = null;
var _objectPublisher = null;
var _model = null;

function
loaded()
{
    _imagePublisher = _conn.getPublisher({window:"p/cq_1/w_data",binary:true});
    _objectPublisher = _conn.getPublisher({window:"p/cq_2/s",binary:true});

    if (_esp.getParm("load",true))
    {
        _conn.publishUrl("p/cq_1/w_request",new URL("yolo.csv",document.URL).toString(),{publishComplete:createVisuals});
    }
    else
    {
        createVisuals();
    }

    _conn.getProjectXml("p",{response:function(c,data){_model = data;}});
}

function
createVisuals()
{
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    var images = _conn.getEventStream({window:"p/cq_1/w_score",ignore_deletes:true,maxevents:1});
    var objects = _conn.getEventCollection({window:"p/cq_2/object",name:"objects",sort:"count",interval:1000,pagesize:10});

    _viewer = _visuals.createImageViewer("viewer",images,{image:"_image_",header:"This image displays the output of the ESP object detection model with the objects annotated.",image_border:"4px solid #3b99fc"});
    _visuals.createBarChart("objects",objects,{y:["count"],header:"Here are the counts of the objects detected"});

    images.addDelegate({dataChanged:handleImage});

    if (canvas.offsetWidth > 0)
    {
        _viewer.setOpts({image_width:canvas.offsetWidth,image_height:canvas.offsetHeight});
    }

    editProperties();

    _esp.size();
}

function
error(connection,project,message)
{
    alert("error: " + message);
}

function
handleImage(ds,data)
{
    if (data != null)
    {
        var video = document.getElementById("video");

        if (video.paused)
        {
            return;
        }

        for (var image of data)
        {
            var prop;
            var s;

            if (image.hasOwnProperty("_nObjects_"))
            {
                for (var i = 0; i < image._nObjects_; i++)
                {
                    prop = "_Object" + i + "_";
                    s = image[prop].trim();
                    if (s.length > 0)
                    {
                        var o = {};
                        o["position"] = video.currentTime;
                        o["object"] = s;
                        _objectPublisher.add(o);
                        _objectPublisher.publish();
                    }
                }
            }
            else if (image.hasOwnProperty("objCount"))
            {
                for (var i = 0; i < image.objCount; i++)
                {
                    prop = "Object" + i + "_label";
                    s = image[prop].trim();
                    if (s.length > 0)
                    {
                        var o = {};
                        o["position"] = video.currentTime;
                        o["object"] = s;
                        _objectPublisher.add(o);
                        _objectPublisher.publish();
                    }
                }
            }
        }
    }
}

function
init()
{
    var video = document.getElementById("video");
    video.addEventListener("timeupdate",publish);
}

var _maxWidth = 550;
var _maxHeight = 550;
var _width = 0;
var _height = 0;

function
videoLoaded()
{
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");

    _width = video.videoWidth;
    _height = video.videoHeight;

    while (_width > _maxWidth)
    {
        _width *= .9;
        _height *= .9;
    }

    while (_height > _maxHeight)
    {
        _width *= .9;
        _height *= .9;
    }

    _width = parseInt(_width);
    _height = parseInt(_height);

    video.style.width = _width + "px";
    video.style.height = _height + "px";

    canvas.width = _width;
    canvas.height = _height;

    _viewer.setOpt("image_width",_width);
    _viewer.setOpt("image_height",_height);

    video.currentTime = .01;

    var context = canvas.getContext("2d");
    context.drawImage(video,0,0,canvas.width,canvas.height);

    _esp.size(500);
}

function
publish()
{
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    context.drawImage(video,0,0,canvas.width,canvas.height);

    var data = canvas.toDataURL("image/jpeg",_imageQuality);
    var index = data.indexOf(",");
    data = data.substr(index + 1);

    var o = {};
    o["id"] = _esp.guid();

    if (_imagePublisher.isBinary())
    {
        var imagedata = atob(data);
        o["image"] = _esp.createBuffer(imagedata);
    }
    else
    {
        o["image"] = data;
    }

    o["position"] = video.currentTime;

    _imagePublisher.add(o);
    _imagePublisher.publish();
}

var _imageQuality = .5;

function
editProperties()
{
    var video = document.getElementById("video");
    var url = (video.src != null && video.src.length > 0) ? new URL(video.src,document.URL).toString() :  new URL("../data/sample.mp4",document.URL).toString();
    document.getElementById("videoUrl").value = url;
    document.getElementById("textColor").value = _viewer.getOpt("image_text_color","white");

    document.getElementById("imageQuality").value = _imageQuality;
    document.getElementById("playbackRate").value = video.playbackRate;

    _esp.getDialogs().pushModal("properties");
}

function
applyProperties()
{
    var video = document.getElementById("video");
    _esp.getDialogs().popModal("properties");
    var url = new URL(document.getElementById("videoUrl").value,document.URL).toString();

    if (url != video.src)
    {
        video.style.width = "auto";
        video.style.height = "auto";
        video.src = url;
    }

    _viewer.setOpts({image_text_color:document.getElementById("textColor").value});
    _imageQuality = document.getElementById("imageQuality").value;
    video.playbackRate = document.getElementById("playbackRate").value;
}

</script>

<style type="text/css">
button
{
	font-family:AvenirNextforSAS;
	font-size:.875rem;
}
</style>
</head>

<style>

</style>

<body onload="init()">

    <div id="banner">
        <table style="width:100%" cellspacing="0" cellpadding="0">
            <tr>
                <td id="bannerTitle"></td>
                <td class="icon">
                    <a class="icon" href="javascript:editProperties()">&#xf201;</a>
                    <a class="icon" href="javascript:_esp.showCodeDialog('Model XML',_model)" title="Model XML">&#xf7c1;</a>
                    <a class="icon" href="javascript:_visuals.showModel(_conn,{title:'ESP Model',header:'Model Viewer',project:'p',type:true,show_projects:false})" title="ESP Model">&#xf501;</a>
                    <a class="icon" href="javascript:_esp.showFrameDialog('ESP Image Object Detection Example','help.html',{width:'80%',height:'60%'})">&#xf30b;</a>
                </td>
            </tr>
        </table>
    </div>

    <div id="content">
        <div class="layout">
            <video id="video" style="outline:none;border:4px solid #3b99fc" controls="controls" onloadedmetadata="videoLoaded()"></video>
            <canvas id="canvas" style="border:4px solid #3b99fc"></canvas>
            <div id="viewer" class="box" style="width:45%;height:55%"></div>
            <div id="objects" class="box" style="width:45%;height:55%"></div>
        </div>
    </div>

    <div id="footer">&nbsp;</div>

    <div id="properties" class="dialog" style="width:600px">

        <table class="dialogClose" style="width:100%" cellspacing="0" cellpadding="0">
            <tr><td class="icon"><a class="icon dialogTitle" href="javascript:_esp.getDialogs().popModal('properties')">&#xf10c;</a></td></tr>
        </table>

        <div class="dialogTop">

            <div  class="dialogHeader">
                <div class="dialogTitle">
                    <table style="width:100%;border:0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td><div class="dialogTitle">Video Properties</div></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="dialogContent">
                <table border="0" style="width:100%;height:100%" cellspacing="0" cellpadding="0">
                    <tr>
                        <td class="dialogLabel">Video URL:</td>
                    </tr>
                    <tr>
                        <td class="dialogValue"><input id="videoUrl" type="text" value="video.mp4"></input></td>
                    </tr>
                    <tr>
                        <td class="dialogLabel">Object text color:</td>
                    </tr>
                    <tr>
                        <td class="dialogValue"><input id="textColor" type="text"></input></td>
                    </tr>
                    <tr>
                        <td class="dialogLabel">Image quality:</td>
                    </tr>
                    <tr>
                        <td class="dialogValue">
                            <select id="imageQuality">
                                <option value="1">Best</option>
                                <option value="0.5">Good</option>
                                <option value="0.3">Fair</option>
                                <option value="0.1">Poor</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="dialogLabel">Playback rate:</td>
                    </tr>
                    <tr>
                        <td class="dialogValue">
                            <select id="playbackRate">
                                <option value="1">Normal Speed</option>
                                <option value="0.5">Half Speed</option>
                                <option value="0.25">Quarter Speed</option>
                                <option value="2">Double Speed</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="dialogButtons">
            <table style="width:100%">
                <tr>
                    <td class="dialogButton">
                        <span><button class="close" onclick="javascript:applyProperties()">Ok</button></span>
                        <span><button class="close" onclick="javascript:_esp.getDialogs().popModal('properties')">Cancel</button></span>
                    </td>
                </tr>
            </table>
        </div>
    </div>

</body>

</html>
