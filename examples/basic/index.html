<!DOCTYPE html>

<html>

<head>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<title>ESP Basic Example</title>

<link rel="stylesheet" href="../../style/connect.css" />

<script src="https://cdn.plot.ly/plotly-latest.min.js" charset="utf-8"></script>
<script src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../js/main"></script>

<script type="text/javascript">

var _api = null;
var _conn = null;
var _visuals = null;
var _viewer = null;

function
esp(api)
{
    _api = api;

    var parms = api.getParms();

    if (parms.hasOwnProperty("server") == false)
    {
        alert("you must specify ESP server URL");
        return;
    }

    var server = parms["server"];
    delete parms["server"];

    document.getElementById("bannerTitle").innerHTML = document.title + " (" + server + ")";
 
    _visuals = _api.createVisuals(parms);

    _visuals.createWrapper("colors",{header:"Click on the colored areas to generate events",style:{width:"95%",height:"150px"}});

    _api.handleLayout({layout:layout});

    _api.connect(server,{ready:ready});
}

function
layout()
{
    _api.refresh();
}

function
ready(conn)
{
    _conn = conn;

    if (_api.getParm("load",true))
    {
        var  model = "<project threads='4' pubsub='auto'>\
                       <contqueries>\
                         <contquery name='cq' trace='clicks'>\
                           <windows>\
                             <window-source name='clicks' insert-only='true' index='pi_EMPTY'>\
                                <schema-string>id*:string,element:string,x:int32,y:int32</schema-string>\
                             </window-source>\
                             <window-copy name='copy'>\
                                <retention type='bytime_sliding'>30 seconds</retention>\
                             </window-copy>\
                             <window-aggregate name='clicksAggr'>\
                                <schema-string>element*:string,count:int32</schema-string>\
                                <output>\
                                    <field-expr>ESP_aCount()</field-expr>\
                                </output>\
                             </window-aggregate>\
                           </windows>\
                           <edges>\
                             <edge source='clicks' target='copy' />\
                             <edge source='copy' target='clicksAggr' />\
                           </edges>\
                         </contquery>\
                       </contqueries>\
                    </project>";

        _api.showStatus("Loading project...");

        _conn.loadProject("myproject",model,{loaded:loaded},{overwrite:true});
    }
    else
    {
        loaded();
    }
}

var _publisher = null;

function
loaded()
{
    _api.clearStatus();

    _visuals.createLogViewer("logs",_conn,{header:"Log Viewer"});
    _viewer = _visuals.createModelViewer("model",_conn,{header:"Model Viewer",cpu:true,counts:true,schema:true,type:true,index:true,memory:true});
    _viewer.addDelegate({modelLoaded:function(viewer){viewer.project = "myproject"}});

    var clicks  = _conn.getEventCollection({window:"myproject/cq/clicksAggr"});

    _visuals.createBarChart("barchart",clicks,{y:"count",header:"Clicks Chart",xrange:[0,100],orientation:"horizontal",get_color:barcolor});
    _visuals.createGauge("gauges",clicks,{value:"count",segments:5,header:"Clicks Indicators",width:200,range:[0,100],bar_color:"rgba(255,255,255,.7)"});

    _conn.getProjectXml("myproject",{response:function(c,data){document.getElementById("espModelXml").innerText = data;}});

    _publisher = _conn.getPublisher({window:"myproject/cq/clicks"});

    _api.size(1000);
}

function
barcolor(item)
{
    return(item.element);
}

function
publish(evt)
{
    var e = {};
    e["id"] = _conn.guid();
    e["element"] = evt.currentTarget.id;
    e["x"] = evt.clientX;
    e["y"] = evt.clientY;

    _publisher.add(e);
    _publisher.publish();
}

</script>

<body>

    <div id="banner">
        <table style="width:100%" cellspacing="0" cellpadding="0">
            <tr>
                <td id="bannerTitle"></td>
                <td class="icon">
                    <a class="icon" href="javascript:_api.getDialogs().pushModal('espModel')">&#xf426;</a>
                    <a class="icon" href="javascript:_api.getDialogs().pushModal('help')">&#xf30b;</a></td>
                </td>
            </tr>

        </table>
    </div>

    <div id="content" class="container">
        <div class="layout">
            <div id="colors" class="container" style="width:95%;height:95%;display:flex;justify-content:space-around;align-items:center">
                <div id="red" style="width:18%;height:80%;background:red;border:1px solid black" onmousedown="javascript:publish(event)"></div>
                <div id="green" style="width:18%;height:80%;background:green;border:1px solid black" onmousedown="javascript:publish(event)"></div>
                <div id="blue" style="width:18%;height:80%;background:blue;border:1px solid black" onmousedown="javascript:publish(event)"></div>
                <div id="yellow" style="width:18%;height:80%;background:yellow;border:1px solid black" onmousedown="javascript:publish(event)"></div>
                <div id="beige" style="width:18%;height:80%;background:beige;border:1px solid black" onmousedown="javascript:publish(event)"></div>
            </div>
            <div id="barchart" style="width:48%;height:300px"></div>
            <div id="gauges" style="width:48%;height:300px"></div>
            <div id="logs" style="width:48%;height:400px"></div>
            <div id="model" style="width:48%;height:400px"></div>
        </div>
    </div>

    <div id="footer">&nbsp;</div>

    <div id="espModel" class="dialog" style="width:90%;height:90%">

        <table class="dialogClose" style="width:100%" cellspacing="0" cellpadding="0">
            <tr><td class="icon"><a class="icon dialogTitle" href="javascript:_api.getDialogs().popModal('espModel')">&#xf10c;</a></td></tr>
        </table>

        <div class="dialogTop">

            <div  class="dialogHeader">
                <div class="dialogTitle">
                    <table style="width:100%;border:0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td><div class="dialogTitle">ESP Model</div></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="dialogContent" style="width:95%;height:70%;margin:auto">
            <pre id="espModelXml" class="model"></pre>
        </div>
    </div>

    <div id="help" class="dialog" style="width:60%">
        <table class="dialogClose" style="width:100%" cellspacing="0" cellpadding="0">
            <tr><td class="icon"><a class="icon dialogTitle" href="javascript:_api.getDialogs().popModal('help')">&#xf10c;</a></td></tr>
        </table>

        <div class="dialogTop">

            <div  class="dialogHeader">
                <div class="dialogTitle">
                    <table style="width:100%;border:0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td><div class="dialogTitle">ESP Basic Example</div></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="dialogContent">
            This example loads a simple ESP model to count clicks on the colored rectangles on the page. Just click on the rectangles and watch the events come into
            the page. It also contains a log viewer and a model viewer. The model has a time based retention policy so the events will come and go as you click.
        </div>

        <div class="dialogButtons">
            <table style="width:100%">
                <tr>
                    <td class="dialogButton">
                        <span><button class="close" onclick="javascript:_api.getDialogs().popModal('help')">Done</button></span>
                    </td>
                </tr>
            </table>
        </div>
    </div>

</body>

</html>
